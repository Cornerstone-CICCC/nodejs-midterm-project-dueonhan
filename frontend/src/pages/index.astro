---
import Layout from "../layouts/Layout.astro"

const PageTitle = "Login"

---

<Layout title={PageTitle}>
    <main class="login-tontainer">
        <div class="bgi">
            <div class="overlay"></div>
            <form method="POST" class="login-form">
                <h2>Login</h2>
                <p>Login to Your account.</p>

                <div class="form-group">
                    <label for="userid">Userid</label>
                    <input
                    type="text"
                    id="userid"
                    name="userid"
                    required
                    />
                </div>
                
                <div class="form-group">
                    <label for="password">Password</label>
                    <input
                    type="password"
                    id="password"
                    name="password"
                    required
                    />
                </div>

                
				<!--
                <div class="form-links">
                    <div class="left">
                        <input type="checkbox" id="remember" name="remember" value="1">
                        <label for="remember">Remember ID</label>
                    </div>
                    <a href="/reset">Forgot password?</a>
                </div>
				 -->
                <button type="submit" class="btn-login">Login</button>
                <a href="/signup" class="sighup-btn">Create an account</a>
            </form>
        </div>

    </main>
</Layout>

<script>
    const form = document.querySelector(".login-form") as HTMLFormElement; 

    if (form) {
        form.addEventListener("submit", async (e) => {
            e.preventDefault();

            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());

            try {
                const res = await fetch("http://localhost:3700/users/login", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(data),
					credentials: "include"
                });

                const result = await res.json();
                
                if (res.ok) {
                    if (result.redirectTo) {
                        window.location.href = result.redirectTo;
                    } else {
                        alert("Login successful, but destination path is missing.");
                    }
                } else {
                    alert(`Login Failed: ${result.message || "Unknown error"}`);
                }
            } catch (error) {
                console.error("Fetch Error:", error);
                alert("A network error occurred. Check server status.");
            }
        });
    }
</script>